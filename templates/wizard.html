{% extends "base.html" %}
{% block titulo %}Asistente para nueva instalació&oacute;n{% endblock %}
{% block externalcss %}
    <!--suppress HtmlUnknownTarget -->
    <link rel="stylesheet" href="/static/css/consumption_centers/main.css" type="text/css" />
    <link href="/static/js/external/techlab-SmartWizard-1636c86/styles/smart_wizard.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/static/js/external/fancybox/jquery.fancybox.css" type="text/css" />
{% endblock %}
{% block externaljs %}
<script type="text/javascript" src="/static/js/external/techlab-SmartWizard-1636c86/js/jquery.smartWizard-2.0.min.js"></script>
<script type="text/javascript" src="/static/js/external/fancybox/jquery.fancybox.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    	// Smart Wizard
  	  $('#wizard').smartWizard({
          labelNext: "Siguiente",
          labelPrevious: "Anterior",
          labelFinish: "Finalizar",
          transitionEffect:'slideleft',
          onLeaveStep:leaveAStepCallback,
          onFinish:onFinishCallback,
          enableFinishButton:true});

      function leaveAStepCallback(obj){
        var step_num= obj.attr('rel');
        return validateSteps(step_num);
      }

      function onFinishCallback(){
       if(validateAllSteps()){
        $('form').submit();
       }
      }
		});

    function validateAllSteps(){
       var isStepValid = true;

       if(validateStep1() == false){
         isStepValid = false;
         $('#wizard').smartWizard('setError',{stepnum:1,iserror:true});
       }else{
         $('#wizard').smartWizard('setError',{stepnum:1,iserror:false});
       }

       if(validateStep3() == false){
         isStepValid = false;
         $('#wizard').smartWizard('setError',{stepnum:3,iserror:true});
       }else{
         $('#wizard').smartWizard('setError',{stepnum:3,iserror:false});
       }

       if(!isStepValid){
          $('#wizard').smartWizard('showMessage','Please correct the errors in the steps and continue');
       }

       return isStepValid;
    }


    function validateSteps(step){
        var wizard = $('#wizard');
        var isStepValid = true;
        // validate step 1
        if(step == 1){
            if(validateStep1() == false ){
                isStepValid = false;
                wizard.smartWizard('showMessage', 'Por favor selecciona un grupo de empresas, una empresa y el edificio donde se hará la instalación');
                wizard.smartWizard('setError',{stepnum:step,iserror:true});
            }else{
                wizard.smartWizard('setError',{stepnum:step,iserror:false});
            }
        }
        // validate step3
        if(step == 3){
            if(validateStep3() == false ){
                isStepValid = false;
                wizard.smartWizard('showMessage','Please correct the errors in step'+step+ ' and click next.');
                wizard.smartWizard('setError',{stepnum:step,iserror:true});
            }else{
                wizard.smartWizard('setError',{stepnum:step,iserror:false});
            }
        }

        return isStepValid;
    }
    function validateStep1(){
        return ($("#company_cluster").val()>0 && $("#company").val()>0 && $("#building").val()>0);
    }
    function validateStep3(){
        var isValid = true;
        //validate

        return isValid;
    }

    var non_selected_building = function(){
        var building = $("#building");
        building.parent().find("span").text("Selecciona un edificio");
        building.html('<option value="0">Selecciona un edificio</option>');
        building.find('option[value="0"]').attr("selected", "selected");
    };
    var non_selected_company = function(){
        var company = $("company");
        company.parent().find("span").text("Selecciona una empresa");
        company.html('<option value="0">Selecciona una empresa</option>');
        company.find('option[value="0"]').attr("selected", "selected");
    };
    var update_company_url = function(cluster){
        var add_c = $("#add_empresa");
        var url = add_c.attr("href");
        url = url.split("/");
        url.splice(3, url.length-1);
        url = url.join("/");
        url = url+"/?company="+cluster;
        add_c.attr("href", url);
    };
    var update_building_url = function(company){
        var add_b = $("#add_building");
        var url = add_b.attr("href");
        url = url.split("/");
        url.splice(3, url.length-1);
        url = url.join("/");
        url = url+"/?company="+company;
        add_b.attr("href", url);
    };

    var building_set = function(building){
        var url = "/buildings/create_hierarchy_pop/"+building+"/";
        var graphFrame = document.createElement("IFRAME");
        graphFrame.id = "graphFrame";
        graphFrame.src = url;
        $("#step-2").html(graphFrame);
        refresh_iframe_height();
    };

    function refresh_iframe_height(){
        // regresca el height del iframe para ajustarse a su conte
        setTimeout("parent.document.getElementById('graphFrame').height = 600;", 1000);
    }

    function added_user(username, fname, lname){
        var messages = $("#messages");
        messages.append("<span class='msj'>"+fname+" "+lname+" se ha dado de alta con el nombre de usuario '"+username+"'<a onclick=function(){$(this).parent().remove();}>X</a></span>");
    }


</script>

{% endblock %}
{% block document_ready %}
    $(".add").fancybox({
        maxWidth	: 1000,
        maxHeight	: 800,
        fitToView	: false,
        width		: '70%',
        height		: '70%',
        autoSize	: false,
        closeClick	: false,
        openEffect	: 'none',
        closeEffect	: 'none',
        afterClose  : function(){click_flag=true;}
    });
    $("#add_empresa").on("click", function(evt){
        if($("#company_cluster").val()=='0'){
            return false;
        }
    });

    $("#company_cluster").change(function(){
        var cluster = $(this).val();
        if(cluster>0){
            $.ajax({
                url: "/buildings/get_cluster_companies/"+$(this).val()+"/?op={{ operation }}",
                type: "GET",
                dataType: 'json',
                async: 'true',
                success: function(datos){
                    var append_text = '';
                    var notice_text = '';

                    update_company_url(cluster);

                    if(datos[0].all == "none"){
                        notice_text = 'Tu esquema de permisos no tiene permitido dar de alta nuevas empresas para la instalación de un equipo industrial.'+
                                      'Por favor ponte en contacto con el administrador';
                    }else{
                        var first_option = '';
                        first_option='<option value="0">'+
                                'Selecciona una empresa</option>';

                        if(datos[0].company != undefined){
                            append_text = '';
                            for(var i=0; i<datos.length; i++){
                                append_text+='<option value="' + datos[i].pk + '"> ' +
                                        datos[i].company +
                                        '</option>';
                            }
                            non_selected_company();
                            $("#company").html(first_option+append_text);
                            non_selected_building();
                        }else{
                            notice_text = 'El grupo de empresas seleccionado no tiene empresas asociadas.';
                            non_selected_company();
                            non_selected_building();
                        }
                    }
                    $("#add_cluster").find(".notice").text(notice_text);
                }
            });
        }else{
            non_selected_company();
            non_selected_building();
        }
    });
    $("#company").change(function(){
        if($(this).val()>0){
            var company = $(this).val();
            $.ajax({
                url: "/buildings/get_company_buildings/"+$(this).val()+"/?op={{ operation }}",
                type: "GET",
                dataType: 'json',
                async: 'true',
                success: function(datos){
                    var append_text = '';
                    var notice_text = '';
                    if(datos[0].all == "none"){
                        notice_text = 'Tu esquema de permisos no tiene permitido dar de alta nuevos edificios para la instalación de un equipo industrial.'+
                                      'Por favor ponte en contacto con el administrador';
                    }else{

                        update_building_url(company);

                        var first_option = '';
                        first_option='<option value="0">'+
                                'Selecciona un edificio</option>';

                        if(datos[0].building != undefined){
                            append_text = '';
                            for(var i=0; i<datos.length; i++){
                                append_text+='<option value="' + datos[i].pk + '"> ' +
                                        datos[i].building +
                                        '</option>';
                            }
                            non_selected_building();
                            $("#building").html(first_option+append_text);
                        }else{
                            notice_text = 'La empresa no tiene edificios asociados';
                            non_selected_building();
                        }
                    }
                    $("#add_building").find(".notice").text(notice_text);
                }
            });
        }else{
            non_selected_building();
        }
    });

    $("#building").change(function(){
        if($(this).val()>0){
            building_set($(this).val());
        }
    });

{% endblock %}
{% block breadcumbs %}

     <div id="bread_crumbs">
     <a href="/profile/{{ request.user.pk }}/" class="fl username">{{ request.user.first_name }} {{ request.user.last_name }}</a>
        <ul>
            <li><a href="/main/">Inicio</a></li>
            <li>Alta de estructura inicial</li>
        </ul>
        <a href="/logout" id="userLogOut">Cerrar sesión</a>
    </div>

{% endblock %}

{% block contenido %}

    <div id="page_content">
        <div id="contenido_interno">
            <h2 class="titulo_reporte"><span class="building">Alta de estrictura inicial</span></h2>

            <div class="divider" id="divider_top">&nbsp;</div>
            {% if message %}
                <span class="notif {{ msg_type }}">
                    {% autoescape off %}{{ message }}{% endautoescape %}
                <a href="#" onclick="$(this).parent().remove();">X</a>
                </span>
            {% endif %}

            <div id="content">
                <form method="post" action=".">
                <div id="wizard" class="swMain">
                    <ul>
                        <li>
                            <a href="#step-1">
                                <span class="stepNumber">1</span>
                                <span class="stepDesc">
                                    <small>Ubicaci&oacute;n de la instalaci&oacute;n</small>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#step-2">
                                <span class="stepNumber">2</span>
                                <span class="stepDesc">
                                    <small>Estructura de la instalaci&oacute;n</small>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#step-3">
                            <span class="stepNumber">3</span>
                            <span class="stepDesc">
                                <small>Usuarios y permisos</small>
                            </span>
                            </a>
                        </li>
                        <li>
                            <a href="#step-4">
                                <span class="stepNumber">4</span>
                                <span class="stepDesc">
                                    <small>Alarmas</small>
                                </span>
                            </a>
                        </li>
                    </ul>

                    <div id="step-1">
                        <div class="form_content g12">
                            <div class="g12" id="add_cluster_cont">
                                <span class="notice g12"></span>
                                <label for="company_cluster" class="g2">Grupo de empresas<span class="required">*</span></label>
                                <select name="company_cluster" id="company_cluster" class="g9">
                                    <option value="0">Selecciona un grupo de empresas </option>
                                    {% if clusters %}
                                    {% for cluster in clusters %}
                                    <option value="{{cluster.id}}" {% if post.cmp_cluster == cluster.id %} selected {% endif %}>{{ cluster.cluster_name }}</option>
                                    {% endfor %}
                                    {% endif %}

                                </select>
                                <a href="/buildings/add_cluster_pop/" class="add" data-fancybox-type="iframe">Nuevo grupo de empresas</a>
                            </div>
                            <div class="g12" id="add_company_cont">
                                <span class="notice g12"></span>
                                <label for="company" class="g2">Empresa<span class="required">*</span></label>
                                <select name="company" id="company" class="g9">
                                    <option value="0">Selecciona una empresa </option>
                                </select>
                                <a href="/buildings/add_company_pop/" id="add_empresa" class="add" data-fancybox-type="iframe">Nueva empresa</a>
                            </div>
                            <div class="g12" id="add_building_cont">
                                <span class="notice g12"></span>
                                <label for="building" class="g2">Edificio<span class="required">*</span></label>
                                <select name="building" id="building" class="g9">
                                    <option value="0">Selecciona un edificio</option>
                                </select>
                                <a href="/buildings/add_building_pop/" id="add_building" class="add" data-fancybox-type="iframe">Nuevo edificio</a>
                            </div>
                        </div>
                    </div>
                    <div id="step-2">


                    </div>
                    <div id="step-3">
                        <div class="form_content g12">
                            <span id="messages"></span>
                            <ul id="user_role_options">
                                <li>
                                    <a id="add_user"  class="add" data-fancybox-type="iframe">Alta de usuarios</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div id="step-4">

                    </div>


                </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
