{% extends "base.html" %}
{% block titulo %}Reportes{% endblock %}
{% block externalcss %}
    <link rel="stylesheet" href="/static/css/consumption_centers/main.css" type="text/css" />
    <link rel="stylesheet" href="/static/date_picker/css/datepicker.css" type="text/css" />
    <link rel="stylesheet" href="/static/js/external/fancybox/jquery.fancybox.css" type="text/css" />
{% endblock %}
{% block externaljs %}
    <script type="text/javascript" src="/static/js/external/fancybox/jquery.fancybox.js"></script>
    <script type="text/javascript" src="/static/date_picker/js/date_picker.js"></script>

    <script type="text/javascript">
    //<![CDATA[
    function clean_dates(url){
        var f1_init = encodeURIComponent($("#range1_init").val());
        var f1_end = encodeURIComponent($("#range1_end").val());
        var f2_init = encodeURIComponent($("#range2_init").val());
        var f2_end = encodeURIComponent($("#range2_end").val());
        var f3_init = encodeURIComponent($("#range3_init").val());
        var f3_end = encodeURIComponent($("#range3_end").val());
        var f4_init = encodeURIComponent($("#range4_init").val());/**
         *
         * Date picker
         * Author: Stefan Petre www.eyecon.ro
         *
         * Dual licensed under the MIT and GPL licenses
         *
         */
        (function ($) {
            var DatePicker = function () {
                var	ids = {},
                        views = {
                            years: 'datepickerViewYears',
                            moths: 'datepickerViewMonths',
                            days: 'datepickerViewDays'
                        },
                        tpl = {
                            wrapper: '<div class="datepicker"><div class="datepickerContainer"><table cellspacing="0" cellpadding="0"><tbody><tr></tr></tbody></table></div></div>',
                            head: [
                                '<td>',
                                '<table cellspacing="0" cellpadding="0">',
                                '<thead>',
                                '<tr>',
                                '<th class="datepickerGoPrev"><a href="#"><span><%=prev%></span></a></th>',
                                '<th colspan="6" class="datepickerMonth"><a href="#"><span></span></a></th>',
                                '<th class="datepickerGoNext"><a href="#"><span><%=next%></span></a></th>',
                                '</tr>',
                                '<tr class="datepickerDoW">',
                                '<th><span><%=week%></span></th>',
                                '<th><span><%=day1%></span></th>',
                                '<th><span><%=day2%></span></th>',
                                '<th><span><%=day3%></span></th>',
                                '<th><span><%=day4%></span></th>',
                                '<th><span><%=day5%></span></th>',
                                '<th><span><%=day6%></span></th>',
                                '<th><span><%=day7%></span></th>',
                                '</tr>',
                                '</thead>',
                                '</table></td>'
                            ],
                            space : '<td class="datepickerSpace"><div></div></td>',
                            days: [
                                '<tbody class="datepickerDays">',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[0].week%></span></a></th>',
                                '<td class="<%=weeks[0].days[0].classname%>"><a href="#"><span><%=weeks[0].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[1].classname%>"><a href="#"><span><%=weeks[0].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[2].classname%>"><a href="#"><span><%=weeks[0].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[3].classname%>"><a href="#"><span><%=weeks[0].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[4].classname%>"><a href="#"><span><%=weeks[0].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[5].classname%>"><a href="#"><span><%=weeks[0].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[0].days[6].classname%>"><a href="#"><span><%=weeks[0].days[6].text%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[1].week%></span></a></th>',
                                '<td class="<%=weeks[1].days[0].classname%>"><a href="#"><span><%=weeks[1].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[1].classname%>"><a href="#"><span><%=weeks[1].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[2].classname%>"><a href="#"><span><%=weeks[1].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[3].classname%>"><a href="#"><span><%=weeks[1].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[4].classname%>"><a href="#"><span><%=weeks[1].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[5].classname%>"><a href="#"><span><%=weeks[1].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[1].days[6].classname%>"><a href="#"><span><%=weeks[1].days[6].text%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[2].week%></span></a></th>',
                                '<td class="<%=weeks[2].days[0].classname%>"><a href="#"><span><%=weeks[2].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[1].classname%>"><a href="#"><span><%=weeks[2].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[2].classname%>"><a href="#"><span><%=weeks[2].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[3].classname%>"><a href="#"><span><%=weeks[2].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[4].classname%>"><a href="#"><span><%=weeks[2].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[5].classname%>"><a href="#"><span><%=weeks[2].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[2].days[6].classname%>"><a href="#"><span><%=weeks[2].days[6].text%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[3].week%></span></a></th>',
                                '<td class="<%=weeks[3].days[0].classname%>"><a href="#"><span><%=weeks[3].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[1].classname%>"><a href="#"><span><%=weeks[3].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[2].classname%>"><a href="#"><span><%=weeks[3].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[3].classname%>"><a href="#"><span><%=weeks[3].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[4].classname%>"><a href="#"><span><%=weeks[3].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[5].classname%>"><a href="#"><span><%=weeks[3].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[3].days[6].classname%>"><a href="#"><span><%=weeks[3].days[6].text%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[4].week%></span></a></th>',
                                '<td class="<%=weeks[4].days[0].classname%>"><a href="#"><span><%=weeks[4].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[1].classname%>"><a href="#"><span><%=weeks[4].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[2].classname%>"><a href="#"><span><%=weeks[4].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[3].classname%>"><a href="#"><span><%=weeks[4].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[4].classname%>"><a href="#"><span><%=weeks[4].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[5].classname%>"><a href="#"><span><%=weeks[4].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[4].days[6].classname%>"><a href="#"><span><%=weeks[4].days[6].text%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<th class="datepickerWeek"><a href="#"><span><%=weeks[5].week%></span></a></th>',
                                '<td class="<%=weeks[5].days[0].classname%>"><a href="#"><span><%=weeks[5].days[0].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[1].classname%>"><a href="#"><span><%=weeks[5].days[1].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[2].classname%>"><a href="#"><span><%=weeks[5].days[2].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[3].classname%>"><a href="#"><span><%=weeks[5].days[3].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[4].classname%>"><a href="#"><span><%=weeks[5].days[4].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[5].classname%>"><a href="#"><span><%=weeks[5].days[5].text%></span></a></td>',
                                '<td class="<%=weeks[5].days[6].classname%>"><a href="#"><span><%=weeks[5].days[6].text%></span></a></td>',
                                '</tr>',
                                '</tbody>'
                            ],
                            months: [
                                '<tbody class="<%=className%>">',
                                '<tr>',
                                '<td colspan="2"><a href="#"><span><%=data[0]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[1]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[2]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[3]%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<td colspan="2"><a href="#"><span><%=data[4]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[5]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[6]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[7]%></span></a></td>',
                                '</tr>',
                                '<tr>',
                                '<td colspan="2"><a href="#"><span><%=data[8]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[9]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[10]%></span></a></td>',
                                '<td colspan="2"><a href="#"><span><%=data[11]%></span></a></td>',
                                '</tr>',
                                '</tbody>'
                            ]
                        },
                        defaults = {
                            flat: false,
                            starts: 1,
                            prev: '&#9664;',
                            next: '&#9654;',
                            lastSel: false,
                            mode: 'single',
                            view: 'days',
                            calendars: 1,
                            format: 'Y-m-d',
                            position: 'bottom',
                            eventName: 'click',
                            onRender: function(){return {};},
                            onChange: function(){return true;},
                            onShow: function(){return true;},
                            onBeforeShow: function(){return true;},
                            onHide: function(){return true;},
                            locale: {
                                days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"],
                                daysShort: ["Dom", "Lun", "Mar", "Mie", "Jue", "Vie", "Sab", "Dom"],
                                daysMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"],
                                months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                                monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                                weekMin: 's'
                            }
                        },
                        fill = function(el) {
                            var options = $(el).data('datepicker');
                            var cal = $(el);
                            var currentCal = Math.floor(options.calendars/2), date, data, dow, month, cnt = 0, week, days, indic, indic2, html, tblCal;
                            cal.find('td>table tbody').remove();
                            for (var i = 0; i < options.calendars; i++) {
                                date = new Date(options.current);
                                date.addMonths(-currentCal + i);
                                tblCal = cal.find('table').eq(i+1);

                                switch (tblCal[0].className) {
                                    case 'datepickerViewDays':
                                        dow = formatDate(date, 'B, Y');
                                        break;
                                    case 'datepickerViewMonths':
                                        dow = date.getFullYear();
                                        break;
                                    case 'datepickerViewYears':
                                        dow = (date.getFullYear()-6) + ' - ' + (date.getFullYear()+5);
                                        break;
                                }
                                tblCal.find('thead tr:first th:eq(1) span').text(dow);
                                dow = date.getFullYear()-6;
                                data = {
                                    data: [],
                                    className: 'datepickerYears'
                                }
                                for ( var j = 0; j < 12; j++) {
                                    data.data.push(dow + j);
                                }
                                html = tmpl(tpl.months.join(''), data);
                                date.setDate(1);
                                data = {weeks:[], test: 10};
                                month = date.getMonth();
                                var dow = (date.getDay() - options.starts) % 7;
                                date.addDays(-(dow + (dow < 0 ? 7 : 0)));
                                week = -1;
                                cnt = 0;
                                while (cnt < 42) {
                                    indic = parseInt(cnt/7,10);
                                    indic2 = cnt%7;
                                    if (!data.weeks[indic]) {
                                        week = date.getWeekNumber();
                                        data.weeks[indic] = {
                                            week: week,
                                            days: []
                                        };
                                    }
                                    data.weeks[indic].days[indic2] = {
                                        text: date.getDate(),
                                        classname: []
                                    };
                                    if (month != date.getMonth()) {
                                        data.weeks[indic].days[indic2].classname.push('datepickerNotInMonth');
                                    }
                                    if (date.getDay() == 0) {
                                        data.weeks[indic].days[indic2].classname.push('datepickerSunday');
                                    }
                                    if (date.getDay() == 6) {
                                        data.weeks[indic].days[indic2].classname.push('datepickerSaturday');
                                    }
                                    var fromUser = options.onRender(date);
                                    var val = date.valueOf();
                                    if (fromUser.selected || options.date == val || $.inArray(val, options.date) > -1 || (options.mode == 'range' && val >= options.date[0] && val <= options.date[1])) {
                                        data.weeks[indic].days[indic2].classname.push('datepickerSelected');
                                    }
                                    if (fromUser.disabled) {
                                        data.weeks[indic].days[indic2].classname.push('datepickerDisabled');
                                    }
                                    if (fromUser.className) {
                                        data.weeks[indic].days[indic2].classname.push(fromUser.className);
                                    }
                                    data.weeks[indic].days[indic2].classname = data.weeks[indic].days[indic2].classname.join(' ');
                                    cnt++;
                                    date.addDays(1);
                                }
                                html = tmpl(tpl.days.join(''), data) + html;
                                data = {
                                    data: options.locale.monthsShort,
                                    className: 'datepickerMonths'
                                };

                                html = tmpl(tpl.months.join(''), data) + html;

                                tblCal.append(html);
                            }
                        },
                        parseDate = function (date, format) {
                            if (date.constructor == Date) {
                                return new Date(date);
                            }
                            var parts = date.split(/\W+/);
                            var against = format.split(/\W+/), d, m, y, h, min, now = new Date();
                            for (var i = 0; i < parts.length; i++) {
                                switch (against[i]) {
                                    case 'd':
                                    case 'e':
                                        d = parseInt(parts[i],10);
                                        break;
                                    case 'm':
                                        m = parseInt(parts[i], 10)-1;
                                        break;
                                    case 'Y':
                                    case 'y':
                                        y = parseInt(parts[i], 10);
                                        y += y > 100 ? 0 : (y < 29 ? 2000 : 1900);
                                        break;
                                    case 'H':
                                    case 'I':
                                    case 'k':
                                    case 'l':
                                        h = parseInt(parts[i], 10);
                                        break;
                                    case 'P':
                                    case 'p':
                                        if (/pm/i.test(parts[i]) && h < 12) {
                                            h += 12;
                                        } else if (/am/i.test(parts[i]) && h >= 12) {
                                            h -= 12;
                                        }
                                        break;
                                    case 'M':
                                        min = parseInt(parts[i], 10);
                                        break;
                                }
                            }
                            return new Date(
                                    y === undefined ? now.getFullYear() : y,
                                    m === undefined ? now.getMonth() : m,
                                    d === undefined ? now.getDate() : d,
                                    h === undefined ? now.getHours() : h,
                                    min === undefined ? now.getMinutes() : min,
                                    0
                            );
                        },
                        formatDate = function(date, format) {
                            var m = date.getMonth();
                            var d = date.getDate();
                            var y = date.getFullYear();
                            var wn = date.getWeekNumber();
                            var w = date.getDay();
                            var s = {};
                            var hr = date.getHours();
                            var pm = (hr >= 12);
                            var ir = (pm) ? (hr - 12) : hr;
                            var dy = date.getDayOfYear();
                            if (ir == 0) {
                                ir = 12;
                            }
                            var min = date.getMinutes();
                            var sec = date.getSeconds();
                            var parts = format.split(''), part;
                            for ( var i = 0; i < parts.length; i++ ) {
                                part = parts[i];
                                switch (parts[i]) {
                                    case 'a':
                                        part = date.getDayName();
                                        break;
                                    case 'A':
                                        part = date.getDayName(true);
                                        break;
                                    case 'b':
                                        part = date.getMonthName();
                                        break;
                                    case 'B':
                                        part = date.getMonthName(true);
                                        break;
                                    case 'C':
                                        part = 1 + Math.floor(y / 100);
                                        break;
                                    case 'd':
                                        part = (d < 10) ? ("0" + d) : d;
                                        break;
                                    case 'e':
                                        part = d;
                                        break;
                                    case 'H':
                                        part = (hr < 10) ? ("0" + hr) : hr;
                                        break;
                                    case 'I':
                                        part = (ir < 10) ? ("0" + ir) : ir;
                                        break;
                                    case 'j':
                                        part = (dy < 100) ? ((dy < 10) ? ("00" + dy) : ("0" + dy)) : dy;
                                        break;
                                    case 'k':
                                        part = hr;
                                        break;
                                    case 'l':
                                        part = ir;
                                        break;
                                    case 'm':
                                        part = (m < 9) ? ("0" + (1+m)) : (1+m);
                                        break;
                                    case 'M':
                                        part = (min < 10) ? ("0" + min) : min;
                                        break;
                                    case 'p':
                                    case 'P':
                                        part = pm ? "PM" : "AM";
                                        break;
                                    case 's':
                                        part = Math.floor(date.getTime() / 1000);
                                        break;
                                    case 'S':
                                        part = (sec < 10) ? ("0" + sec) : sec;
                                        break;
                                    case 'u':
                                        part = w + 1;
                                        break;
                                    case 'w':
                                        part = w;
                                        break;
                                    case 'y':
                                        part = ('' + y).substr(2, 2);
                                        break;
                                    case 'Y':
                                        part = y;
                                        break;
                                }
                                parts[i] = part;
                            }
                            return parts.join('');
                        },
                        extendDate = function(options) {
                            if (Date.prototype.tempDate) {
                                return;
                            }
                            Date.prototype.tempDate = null;
                            Date.prototype.months = options.months;
                            Date.prototype.monthsShort = options.monthsShort;
                            Date.prototype.days = options.days;
                            Date.prototype.daysShort = options.daysShort;
                            Date.prototype.getMonthName = function(fullName) {
                                return this[fullName ? 'months' : 'monthsShort'][this.getMonth()];
                            };
                            Date.prototype.getDayName = function(fullName) {
                                return this[fullName ? 'days' : 'daysShort'][this.getDay()];
                            };
                            Date.prototype.addDays = function (n) {
                                this.setDate(this.getDate() + n);
                                this.tempDate = this.getDate();
                            };
                            Date.prototype.addMonths = function (n) {
                                if (this.tempDate == null) {
                                    this.tempDate = this.getDate();
                                }
                                this.setDate(1);
                                this.setMonth(this.getMonth() + n);
                                this.setDate(Math.min(this.tempDate, this.getMaxDays()));
                            };
                            Date.prototype.addYears = function (n) {
                                if (this.tempDate == null) {
                                    this.tempDate = this.getDate();
                                }
                                this.setDate(1);
                                this.setFullYear(this.getFullYear() + n);
                                this.setDate(Math.min(this.tempDate, this.getMaxDays()));
                            };
                            Date.prototype.getMaxDays = function() {
                                var tmpDate = new Date(Date.parse(this)),
                                        d = 28, m;
                                m = tmpDate.getMonth();
                                d = 28;
                                while (tmpDate.getMonth() == m) {
                                    d ++;
                                    tmpDate.setDate(d);
                                }
                                return d - 1;
                            };
                            Date.prototype.getFirstDay = function() {
                                var tmpDate = new Date(Date.parse(this));
                                tmpDate.setDate(1);
                                return tmpDate.getDay();
                            };
                            Date.prototype.getWeekNumber = function() {
                                var tempDate = new Date(this);
                                tempDate.setDate(tempDate.getDate() - (tempDate.getDay() + 6) % 7 + 3);
                                var dms = tempDate.valueOf();
                                tempDate.setMonth(0);
                                tempDate.setDate(4);
                                return Math.round((dms - tempDate.valueOf()) / (604800000)) + 1;
                            };
                            Date.prototype.getDayOfYear = function() {
                                var now = new Date(this.getFullYear(), this.getMonth(), this.getDate(), 0, 0, 0);
                                var then = new Date(this.getFullYear(), 0, 0, 0, 0, 0);
                                var time = now - then;
                                return Math.floor(time / 24*60*60*1000);
                            };
                        },
                        layout = function (el) {
                            var options = $(el).data('datepicker');
                            var cal = $('#' + options.id);
                            if (!options.extraHeight) {
                                var divs = $(el).find('div');
                                if (divs.get(0) && divs.get(2))
                                    options.extraHeight = divs.get(0).offsetHeight + divs.get(1).offsetHeight;
                                if(divs.get(2) && divs.get(3))
                                    options.extraWidth = divs.get(2).offsetWidth + divs.get(3).offsetWidth;
                            }
                            var tbl = cal.find('table:first').get(0);
                            var width = tbl.offsetWidth;
                            var height = tbl.offsetHeight;
                            cal.css({
                                width: width + options.extraWidth + 'px',
                                height: height + options.extraHeight + 'px'
                            }).find('div.datepickerContainer').css({
                                        width: width + 'px',
                                        height: height + 'px'
                                    });
                        },
                        click = function(ev) {
                            if ($(ev.target).is('span')) {
                                ev.target = ev.target.parentNode;
                            }
                            var el = $(ev.target);
                            if (el.is('a')) {
                                ev.target.blur();
                                if (el.hasClass('datepickerDisabled')) {
                                    return false;
                                }
                                var options = $(this).data('datepicker');
                                var parentEl = el.parent();
                                var tblEl = parentEl.parent().parent().parent();
                                var tblIndex = $('table', this).index(tblEl.get(0)) - 1;
                                var tmp = new Date(options.current);
                                var changed = false;
                                var fillIt = false;
                                if (parentEl.is('th')) {
                                    if (parentEl.hasClass('datepickerWeek') && options.mode == 'range' && !parentEl.next().hasClass('datepickerDisabled')) {
                                        var val = parseInt(parentEl.next().text(), 10);
                                        tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
                                        if (parentEl.next().hasClass('datepickerNotInMonth')) {
                                            tmp.addMonths(val > 15 ? -1 : 1);
                                        }
                                        tmp.setDate(val);
                                        options.date[0] = (tmp.setHours(0,0,0,0)).valueOf();
                                        tmp.setHours(23,59,59,0);
                                        tmp.addDays(6);
                                        options.date[1] = tmp.valueOf();
                                        fillIt = true;
                                        changed = true;
                                        options.lastSel = false;
                                    } else if (parentEl.hasClass('datepickerMonth')) {
                                        tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
                                        switch (tblEl.get(0).className) {
                                            case 'datepickerViewDays':
                                                tblEl.get(0).className = 'datepickerViewMonths';
                                                el.find('span').text(tmp.getFullYear());
                                                break;
                                            case 'datepickerViewMonths':
                                                tblEl.get(0).className = 'datepickerViewYears';
                                                el.find('span').text((tmp.getFullYear()-6) + ' - ' + (tmp.getFullYear()+5));
                                                break;
                                            case 'datepickerViewYears':
                                                tblEl.get(0).className = 'datepickerViewDays';
                                                el.find('span').text(formatDate(tmp, 'B, Y'));
                                                break;
                                        }
                                    } else if (parentEl.parent().parent().is('thead')) {
                                        switch (tblEl.get(0).className) {
                                            case 'datepickerViewDays':
                                                options.current.addMonths(parentEl.hasClass('datepickerGoPrev') ? -1 : 1);
                                                break;
                                            case 'datepickerViewMonths':
                                                options.current.addYears(parentEl.hasClass('datepickerGoPrev') ? -1 : 1);
                                                break;
                                            case 'datepickerViewYears':
                                                options.current.addYears(parentEl.hasClass('datepickerGoPrev') ? -12 : 12);
                                                break;
                                        }
                                        fillIt = true;
                                    }
                                } else if (parentEl.is('td') && !parentEl.hasClass('datepickerDisabled')) {
                                    switch (tblEl.get(0).className) {
                                        case 'datepickerViewMonths':
                                            options.current.setMonth(tblEl.find('tbody.datepickerMonths td').index(parentEl));
                                            options.current.setFullYear(parseInt(tblEl.find('thead th.datepickerMonth span').text(), 10));
                                            options.current.addMonths(Math.floor(options.calendars/2) - tblIndex);
                                            tblEl.get(0).className = 'datepickerViewDays';
                                            break;
                                        case 'datepickerViewYears':
                                            options.current.setFullYear(parseInt(el.text(), 10));
                                            tblEl.get(0).className = 'datepickerViewMonths';
                                            break;
                                        default:
                                            var val = parseInt(el.text(), 10);
                                            tmp.addMonths(tblIndex - Math.floor(options.calendars/2));
                                            if (parentEl.hasClass('datepickerNotInMonth')) {
                                                tmp.addMonths(val > 15 ? -1 : 1);
                                            }
                                            tmp.setDate(val);
                                            switch (options.mode) {
                                                case 'multiple':
                                                    val = (tmp.setHours(0,0,0,0)).valueOf();
                                                    if ($.inArray(val, options.date) > -1) {
                                                        $.each(options.date, function(nr, dat){
                                                            if (dat == val) {
                                                                options.date.splice(nr,1);
                                                                return false;
                                                            }
                                                        });
                                                    } else {
                                                        options.date.push(val);
                                                    }
                                                    break;
                                                case 'range':
                                                    if (!options.lastSel) {
                                                        options.date[0] = (tmp.setHours(0,0,0,0)).valueOf();
                                                    }
                                                    val = (tmp.setHours(23,59,59,0)).valueOf();
                                                    if (val < options.date[0]) {
                                                        options.date[1] = options.date[0] + 86399000;
                                                        options.date[0] = val - 86399000;
                                                    } else {
                                                        options.date[1] = val;
                                                    }
                                                    options.lastSel = !options.lastSel;
                                                    break;
                                                default:
                                                    options.date = tmp.valueOf();
                                                    break;
                                            }
                                            break;
                                    }
                                    fillIt = true;
                                    changed = true;
                                }
                                if (fillIt) {
                                    fill(this);
                                }
                                if (changed) {
                                    options.onChange.apply(this, prepareDate(options));
                                }
                            }
                            return false;
                        },
                        prepareDate = function (options) {
                            var tmp;
                            if (options.mode == 'single') {
                                tmp = new Date(options.date);
                                return [formatDate(tmp, options.format), tmp, options.el];
                            } else {
                                tmp = [[],[], options.el];
                                $.each(options.date, function(nr, val){
                                    var date = new Date(val);
                                    tmp[0].push(formatDate(date, options.format));
                                    tmp[1].push(date);
                                });
                                return tmp;
                            }
                        },
                        getViewport = function () {
                            var m = document.compatMode == 'CSS1Compat';
                            return {
                                l : window.pageXOffset || (m ? document.documentElement.scrollLeft : document.body.scrollLeft),
                                t : window.pageYOffset || (m ? document.documentElement.scrollTop : document.body.scrollTop),
                                w : window.innerWidth || (m ? document.documentElement.clientWidth : document.body.clientWidth),
                                h : window.innerHeight || (m ? document.documentElement.clientHeight : document.body.clientHeight)
                            };
                        },
                        isChildOf = function(parentEl, el, container) {
                            if (parentEl == el) {
                                return true;
                            }
                            if (parentEl.contains) {
                                return parentEl.contains(el);
                            }
                            if ( parentEl.compareDocumentPosition ) {
                                return !!(parentEl.compareDocumentPosition(el) & 16);
                            }
                            var prEl = el.parentNode;
                            while(prEl && prEl != container) {
                                if (prEl == parentEl)
                                    return true;
                                prEl = prEl.parentNode;
                            }
                            return false;
                        },
                        show = function (ev) {
                            var cal = $('#' + $(this).data('datepickerId'));
                            if (!cal.is(':visible')) {
                                var calEl = cal.get(0);
                                fill(calEl);
                                var options = cal.data('datepicker');
                                options.onBeforeShow.apply(this, [cal.get(0)]);
                                var pos = $(this).offset();
                                var viewPort = getViewport();
                                var top = pos.top;
                                var left = pos.left;
                                var oldDisplay = $.curCSS(calEl, 'display');
                                cal.css({
                                    visibility: 'hidden',
                                    display: 'block'
                                });
                                layout(calEl);
                                switch (options.position){
                                    case 'top':
                                        top -= calEl.offsetHeight;
                                        break;
                                    case 'left':
                                        left -= calEl.offsetWidth;
                                        break;
                                    case 'right':
                                        left += this.offsetWidth;
                                        break;
                                    case 'bottom':
                                        top += this.offsetHeight;
                                        break;
                                }
                                if (top + calEl.offsetHeight > viewPort.t + viewPort.h) {
                                    top = pos.top  - calEl.offsetHeight;
                                }
                                if (top < viewPort.t) {
                                    top = pos.top + this.offsetHeight + calEl.offsetHeight;
                                }
                                if (left + calEl.offsetWidth > viewPort.l + viewPort.w) {
                                    left = pos.left - calEl.offsetWidth;
                                }
                                if (left < viewPort.l) {
                                    left = pos.left + this.offsetWidth
                                }
                                cal.css({
                                    visibility: 'visible',
                                    display: 'block',
                                    top: top + 'px',
                                    left: left + 'px'
                                });
                                if (options.onShow.apply(this, [cal.get(0)]) != false) {
                                    cal.show();
                                }
                                $(document).bind('mousedown', {cal: cal, trigger: this}, hide);
                            }
                            return false;
                        },
                        hide = function (ev) {
                            if (ev.target != ev.data.trigger && !isChildOf(ev.data.cal.get(0), ev.target, ev.data.cal.get(0))) {
                                if (ev.data.cal.data('datepicker').onHide.apply(this, [ev.data.cal.get(0)]) != false) {
                                    ev.data.cal.hide();
                                }
                                $(document).unbind('mousedown', hide);
                            }
                        };
                return {
                    init: function(options){
                        options = $.extend({}, defaults, options||{});
                        extendDate(options.locale);
                        options.calendars = Math.max(1, parseInt(options.calendars,10)||1);
                        options.mode = /single|multiple|range/.test(options.mode) ? options.mode : 'single';
                        return this.each(function(){
                            if (!$(this).data('datepicker')) {
                                options.el = this;
                                if (options.date.constructor == String) {
                                    options.date = parseDate(options.date, options.format);
                                    options.date.setHours(0,0,0,0);
                                }
                                if (options.mode != 'single') {
                                    if (options.date.constructor != Array) {
                                        options.date = [options.date.valueOf()];
                                        if (options.mode == 'range') {
                                            options.date.push(((new Date(options.date[0])).setHours(23,59,59,0)).valueOf());
                                        }
                                    } else {
                                        for (var i = 0; i < options.date.length; i++) {
                                            options.date[i] = (parseDate(options.date[i], options.format).setHours(0,0,0,0)).valueOf();
                                        }
                                        if (options.mode == 'range') {
                                            options.date[1] = ((new Date(options.date[1])).setHours(23,59,59,0)).valueOf();
                                        }
                                    }
                                } else {
                                    options.date = options.date.valueOf();
                                }
                                if (!options.current) {
                                    options.current = new Date();
                                } else {
                                    options.current = parseDate(options.current, options.format);
                                }
                                options.current.setDate(1);
                                options.current.setHours(0,0,0,0);
                                var id = 'datepicker_' + parseInt(Math.random() * 1000), cnt;
                                options.id = id;
                                $(this).data('datepickerId', options.id);
                                var cal = $(tpl.wrapper).attr('id', id).bind('click', click).data('datepicker', options);
                                if (options.className) {
                                    cal.addClass(options.className);
                                }
                                var html = '';
                                for (var i = 0; i < options.calendars; i++) {
                                    cnt = options.starts;
                                    if (i > 0) {
                                        html += tpl.space;
                                    }
                                    html += tmpl(tpl.head.join(''), {
                                        week: options.locale.weekMin,
                                        prev: options.prev,
                                        next: options.next,
                                        day1: options.locale.daysMin[(cnt++)%7],
                                        day2: options.locale.daysMin[(cnt++)%7],
                                        day3: options.locale.daysMin[(cnt++)%7],
                                        day4: options.locale.daysMin[(cnt++)%7],
                                        day5: options.locale.daysMin[(cnt++)%7],
                                        day6: options.locale.daysMin[(cnt++)%7],
                                        day7: options.locale.daysMin[(cnt++)%7]
                                    });
                                }
                                cal
                                        .find('tr:first').append(html)
                                        .find('table').addClass(views[options.view]);
                                fill(cal.get(0));
                                if (options.flat) {
                                    cal.appendTo(this).show().css('position', 'relative');
                                    layout(cal.get(0));
                                } else {
                                    cal.appendTo(document.body);
                                    $(this).bind(options.eventName, show);
                                }
                            }
                        });
                    },
                    showPicker: function() {
                        return this.each( function () {
                            if ($(this).data('datepickerId')) {
                                show.apply(this);
                            }
                        });
                    },
                    hidePicker: function() {
                        return this.each( function () {
                            if ($(this).data('datepickerId')) {
                                $('#' + $(this).data('datepickerId')).hide();
                            }
                        });
                    },
                    setDate: function(date, shiftTo){
                        return this.each(function(){
                            if ($(this).data('datepickerId')) {
                                var cal = $('#' + $(this).data('datepickerId'));
                                var options = cal.data('datepicker');
                                options.date = date;
                                if (options.date.constructor == String) {
                                    options.date = parseDate(options.date, options.format);
                                    options.date.setHours(0,0,0,0);
                                }
                                if (options.mode != 'single') {
                                    if (options.date.constructor != Array) {
                                        options.date = [options.date.valueOf()];
                                        if (options.mode == 'range') {
                                            options.date.push(((new Date(options.date[0])).setHours(23,59,59,0)).valueOf());
                                        }
                                    } else {
                                        for (var i = 0; i < options.date.length; i++) {
                                            options.date[i] = (parseDate(options.date[i], options.format).setHours(0,0,0,0)).valueOf();
                                        }
                                        if (options.mode == 'range') {
                                            options.date[1] = ((new Date(options.date[1])).setHours(23,59,59,0)).valueOf();
                                        }
                                    }
                                } else {
                                    options.date = options.date.valueOf();
                                }
                                if (shiftTo) {
                                    options.current = new Date (options.mode != 'single' ? options.date[0] : options.date);
                                }
                                fill(cal.get(0));
                            }
                        });
                    },
                    getDate: function(formated) {
                        if (this.size() > 0) {
                            return prepareDate($('#' + $(this).data('datepickerId')).data('datepicker'))[formated ? 0 : 1];
                        }
                    },
                    clear: function(){
                        return this.each(function(){
                            if ($(this).data('datepickerId')) {
                                var cal = $('#' + $(this).data('datepickerId'));
                                var options = cal.data('datepicker');
                                if (options.mode != 'single') {
                                    options.date = [];
                                    fill(cal.get(0));
                                }
                            }
                        });
                    },
                    fixLayout: function(){
                        return this.each(function(){
                            if ($(this).data('datepickerId')) {
                                var cal = $('#' + $(this).data('datepickerId'));
                                var options = cal.data('datepicker');
                                if (options.flat) {
                                    layout(cal.get(0));
                                }
                            }
                        });
                    }
                };
            }();
            $.fn.extend({
                DatePicker: DatePicker.init,
                DatePickerHide: DatePicker.hidePicker,
                DatePickerShow: DatePicker.showPicker,
                DatePickerSetDate: DatePicker.setDate,
                DatePickerGetDate: DatePicker.getDate,
                DatePickerClear: DatePicker.clear,
                DatePickerLayout: DatePicker.fixLayout
            });
        })(jQuery);

        (function(){
            var cache = {};

            this.tmpl = function tmpl(str, data){
                // Figure out if we're getting a template, or if we need to
                // load the template - and be sure to cache the result.
                var fn = !/\W/.test(str) ?
                        cache[str] = cache[str] ||
                                tmpl(document.getElementById(str).innerHTML) :

                    // Generate a reusable function that will serve as a template
                    // generator (and which will be cached).
                        new Function("obj",
                                "var p=[],print=function(){p.push.apply(p,arguments);};" +

                                    // Introduce the data as local variables using with(){}
                                        "with(obj){p.push('" +

                                    // Convert the template into pure JavaScript
                                        str
                                                .replace(/[\r\t\n]/g, " ")
                                                .split("<%").join("\t")
                                                .replace(/((^|%>)[^\t]*)'/g, "$1\r")
                                                .replace(/\t=(.*?)%>/g, "',$1,'")
                                                .split("\t").join("');")
                                                .split("%>").join("p.push('")
                                                .split("\r").join("\\'")
                                        + "');}return p.join('');");

                // Provide some basic currying to the user
                return data ? fn( data ) : fn;
            };
        })();
        var f4_end = encodeURIComponent($("#range4_end").val());

        url=url.replace('#','').split("?");
        if (url.length > 1){
            //if url has get_vars
            var hash = url[1];
            hash = hash.replace(/&{0,1}date-start01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-start02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-start03=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end03=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-start04=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end04=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            //hash is equal to all the get vars but the dates
            url = url[0] + "?" + hash + "&";
        }else{
            url+="?";
        }

        if(f1_init != ''){
            url += "date-start01=" + f1_init;

        }else{
            var fecha_ini = new Date();
            fecha_ini.setDate(fecha_ini.getDate()-30);
            url += "date-start01=" + encodeURIComponent(fecha_ini.format("yyyy-mm-dd"));
        }
        if(f1_end != ''){
            url += "&date-end01=" + f1_end;
        }else{
            url += "&date-end01=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
        }

        if(f2_init != ''){
            url += "&date-start02=" + f2_init;
            if(f2_end != ''){
                url += "&date-end02=" + f2_end;
            }else{
                url += "&date-end02=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
            }
        }
        if(f3_init != ''){
            url += "&date-start03=" + f3_init;
            if(f3_end != ''){
                url += "&date-end03=" + f3_end;
            }else{
                url += "&date-end03=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
            }
        }
        if(f4_init != ''){
            url += "&date-start04=" + f4_init;
            if(f4_end != ''){
                url += "&date-end04=" + f4_end;
            }else{
                url += "&date-end04=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
            }
        }
        return url;
    }
    function append_parameters(base_url){
        var get = getUrlVars();
        if(get.length>0){
            if (get[0]!=window.location.protocol+"//"+window.location
                    .host+window.location.pathname){
                for(var i=0; i<get.length; i++){
                    if (get[i]!="date-start01" || get[i]!="date-start02" || get[i]!="date-start03" || get[i]!="date-start04" || get[i]!="consumer-unit01" || get[i]!="consumer-unit02" || get[i]!="consumer-unit03" || get[i]!="consumer-unit04" ){
                        base_url+="&"+get[i]+"="+get[get[i]];
                    }
                }
            }

        }
        return base_url
    }
    function append_parameters2(base_url){
        var get = getUrlVars();
        if(get.length>0){
            if (get[0]!=window.location.protocol+"//"+window.location
                    .host+window.location.pathname){
                for(var i=0; i<get.length; i++){
                    if (get[i]!="graph" || get[i]!="granularity" || get[i]!="g_type" || get[i]!="_suid" ){
                        base_url+="&"+get[i]+"="+get[get[i]];
                    }
                }
            }

        }
        base_url = base_url.split("#")[0];
        return base_url
    }
    function graphsReload(){
        /* Takes the date in the range inputs and reloads the graph data */

        var f1_init = encodeURIComponent($("#range1_init").val());
        var f1_end = encodeURIComponent($("#range1_end").val());
        var f2_init = encodeURIComponent($("#range2_init").val());
        var f2_end = encodeURIComponent($("#range2_end").val());
        var f3_init = encodeURIComponent($("#range3_init").val());
        var f3_end = encodeURIComponent($("#range3_end").val());
        var f4_init = encodeURIComponent($("#range4_init").val());
        var f4_end = encodeURIComponent($("#range4_end").val());
        if(f1_init!=''){
            var url = $("#graphFrame").attr("src").replace('#','').split("&");
            var base_url=url[0];

            base_url+='&consumer-unit01={{ consumer_unit.pk }}';
            if (url.length > 1){

                base_url += "&date-start01=" + f1_init;
                if(f1_end != ''){
                    base_url += "&date-end01=" + f1_end;
                }else{
                    base_url += "&date-end01=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
                }
                if(f2_init != ''){
                    base_url += "&date-start02=" + f2_init;
                    if(f2_end != ''){
                        base_url += "&date-end02=" + f2_end;
                    }else{
                        base_url += "&date-end02=" + encodeURIComponent(new Date());

                    }
                    base_url += "&consumer-unit02={{ consumer_unit.pk }}"
                }
                if(f3_init != ''){
                    base_url += "&date-start03=" + f3_init;
                    if(f3_end != ''){
                        base_url += "&date-end03=" + f3_end;
                    }else{
                        base_url += "&date-end03=" + encodeURIComponent(new Date());

                    }
                    base_url += "&consumer-unit03={{ consumer_unit.pk }}"
                }
                if(f4_init != ''){
                    base_url += "&date-start04=" + f4_init;
                    if(f4_end != ''){
                        base_url += "&date-end04=" + f4_end;
                    }else{
                        base_url += "&date-end04=" + encodeURIComponent(new Date());

                    }
                    base_url += "&consumer-unit04={{ consumer_unit.pk }}"
                }
                base_url=append_parameters(base_url)+"&granularity=raw_data";
                makeIframe(base_url);
            }else{
                $("#graph_container").html("<h2>Por favor, " +
                        "primero seleccione el tipo de gr&aacute;fica a mostrar</h2>" +
                        "<iframe id='graphFrame' src=''>" +
                        "</iframe>");
            }

        }

    }
    function refresh_iframe_height(){
        // regresca el height del iframe para ajustarse a su conte
        setTimeout("parent.document.getElementById('graphFrame').height = document['body'].offsetHeight;", 1000);
    }
    function makeIframe(src){
        var graphFrame = document.createElement("IFRAME");
        graphFrame.id = "graphFrame";
        graphFrame.src = src;
        $("#graph_container").html(graphFrame);
        refresh_iframe_height();
    }
    //]]>
    </script>
{% endblock %}
{% block document_ready %}

    var url = window.location.href;
    url = url.replace("#", '');
    History.replaceState(url,"Reporte electrico", url);

    var now3 = new Date();
    now3.addDays(-4);
    var now4 = new Date();
    var mul_date, mul_date3, mul_date4 = false;
    $('#widgetCalendar').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range1_init').val(formated[0]);
            $('#range1_end').val(formated[1]);
            if(!mul_date){
                $('#widgetField span').css({'font-size':'16px', 'height':'26px'});
                $('#widgetField span').get(0).innerHTML = formated.join(' &ndash; ');
            }else{
                $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            }
        }
    });
    $('#widgetCalendar').DatePickerClear();
    $('#widgetCalendar2').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range2_init').val(formated[0]);
            $('#range2_end').val(formated[1]);
            $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val();
            $('#widgetField span').get(0).innerHTML = $('#widgetField span').html() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            $('#widgetField span').css('font-size','11px');

        }
    });
    $('#widgetCalendar2').DatePickerClear();

    //-----3rd and 4th calendars-------
    $('#widgetCalendar3').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range3_init').val(formated[0]);
            $('#range3_end').val(formated[1]);

            var inner_text='';
            inner_text= $('#range1_init').val() + " &ndash; " + $('#range1_end').val() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            inner_text+= " contra "+$('#range3_init').val() + " &ndash; " + $('#range3_end').val();
            $('#widgetField span').get(0).innerHTML = inner_text;
            $('#widgetField').css({'font-size':'11px', 'height': '52px' });
    }
    });
    $('#widgetCalendar3').DatePickerClear();
    $('#widgetCalendar4').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range4_init').val(formated[0]);
            $('#range4_end').val(formated[1]);
            var inner_text = '';
            inner_text= $('#range1_init').val() + " &ndash; " + $('#range1_end').val() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            inner_text+= " contra: "+$('#range3_init').val() + " &ndash; " + $('#range3_end').val() + " contra: " + $('#range4_init').val() + " &ndash; " + $('#range4_end').val();
            $('#widgetField span').get(0).innerHTML = inner_text;
            $('#widgetField').css({'font-size':'11px', 'height': '52px', 'width': '362px' });
        }
    });
    $('#widgetCalendar4').DatePickerClear();

    var state = false;
    $('#widgetField').click(function(){
        $('#datepicker').slideToggle();
    });
    $("#date_ranges .aqua_btn").click(function(e){
        //aplicar el(los) rangos de fecha seleccionados
        e.preventDefault();
        $('#datepicker').slideUp();
        graphsReload();
    });
    $("#prev_dates").click(function(){
        //maneja la visibilidad del calendario del rango adicional
        if($("#widgetCalendar2").is(":visible")){
            mul_date = false;
            $('#range2_init').val("");
            $('#range2_end').val("");
            $('#widgetField span').html($('#widgetField span').html().split(" contra: ")[0]);
            $('#widgetCalendar2').DatePickerClear();
        }else{
            mul_date = true;
        }
        $("#widgetCalendar2").slideToggle();
    });

    $("#prev_dates3").click(function(){
        //maneja la visibilidad del calendario del rango adicional
        if($("#widgetCalendar3").is(":visible")){
            mul_date3 = false;
            $('#range3_init').val("");
            $('#range3_end').val("");
            var span_content=$('#widgetField span').html().split(" contra: ")
            $('#widgetField span').html(span_content[0]+" contra: "+span_content[1]);
            $('#widgetCalendar3').DatePickerClear();
        }else{
            mul_date = true;
        }
        $("#widgetCalendar3").slideToggle();
    });

    $("#prev_dates4").click(function(){
        //maneja la visibilidad del calendario del rango adicional
        if($("#widgetCalendar4").is(":visible")){
            mul_date4 = false;
            $('#range4_init').val("");
            $('#range4_end').val("");
            var span_content=$('#widgetField span').html().split(" contra: ")
            $('#widgetField span').html(span_content[0]+" contra: "+span_content[1]+" contra: "+span_content[2]);
            $('#widgetCalendar4').DatePickerClear();
        }else{
            mul_date = true;
        }
        $("#widgetCalendar4").slideToggle();
    });

    $("#types_graphs ul li").each(function(){
        // Carga el iframe de la grafica correspondiente,
        $(this).click(function(){
            $("#types_graphs ul li").each(function(){$(this).removeClass("active");});
            var src;
            switch($(this).attr("id")){
                {% for type in graphs %}
                case "{{ type.pk }}":
                    src = "{{ type.object_access_point }}";
                    break;
                {% endfor %}
            }


            //var get_vars = $("#graphFrame").attr("src").split('?')[1]


                if(src == "/reportes/graficas?graph=TotalkWhIMPORT" || src == "/reportes/graficas?graph=kWh_consumido"){
                    src+='&granularity=day';
                }else{
                    src+='&granularity=raw_data';
                }

                src=append_parameters2(src);

                src+="&consumer-unit01="+String({{ consumer_unit.pk }});
                if ($("#range2_init").val()!=''){
                    src+="&consumer-unit02="+String({{ consumer_unit.pk }});
                }
                if ($("#range3_init").val()!=''){
                    src+="&consumer-unit03="+String({{ consumer_unit.pk }});
                }
                if ($("#range4_init").val()!=''){
                    src+="&consumer-unit04="+String({{ consumer_unit.pk }});
                }

                //makeIframe(src);
                src=clean_dates(src)

                makeIframe(src);
                //cambia la clase de la pestania
                $(this).addClass("active");



        });
    });
    /*$("#compare_to").change(function(){
        //agrega y refresca los datos para ser comparados contra otra entidad
        var compared_companies=$("#evaluated_companies").val().split(",");
        if($(this).val()!=0 && compared_companies.length < 4){

            var bandera = true;
            for(var comp = 0; comp < compared_companies.length; comp++){
                //check if the entitie is compared with self, or some entity already added
                if(compared_companies[comp] == $(this).val()) bandera = false;
            }
            if(bandera){
                var src=$("#graphFrame").attr("src").split('?');
                var iframesrc = src[0] + '?';

                if (src[1] != undefined){
                    iframesrc += src[1] + '&';
                }
                iframesrc += "compare_to" + $(this).val() + "=" + $(this).val();
                $(this).parent().before('<span class="compared">' + $("#compare_to option:selected").text()
                                    + '</span><span class="vs_tag">VS</span>');
                src = iframesrc;

                makeIframe(src);
                $("#evaluated_companies").val($("#evaluated_companies").val() + "," + $(this).val());
            }
        }
    });*/

    refresh_iframe_height();

    $(".various").fancybox({
        maxWidth	: 800,
        maxHeight	: 800,
        fitToView	: false,
        width		: '70%',
        height		: '70%',
        autoSize	: false,
        closeClick	: false,
        openEffect	: 'none',
        closeEffect	: 'none'
    });
    if($("#graphFrame").attr("src")=="/reportes/graficas/"){
        $("#types_graphs ul li:eq(0)").click();
    }
    {% endblock %}
{% block contenido %}
<div id="bread_crumbs">
    <ul>
        <li><a href="/main/">Inicio</a></li>
        <li><a href="/main/">Reportes</a></li>
    </ul>

</div>
<div id="contenido_interno">
    <h2 id="titulo_reporte">{{ empresa.building_name }} -
        <span>
            {% if consumer_unit.part_of_building %}
                {{ consumer_unit.part_of_building.part_of_building_name }}
            {% else %}
                {{ consumer_unit.electric_device_type.electric_device_type_name }}
            {% endif %}
        </span>
    </h2><a class="various" data-fancybox-type="iframe"  href="/reportes/set_consumer_unit/">Cambiar</a>

    <div id="datepicker_component">
        <span class="period_tag">Periodo</span>
        <div id="widgetField">
            <span>Fecha Inicio &ndash; Fecha Fin</span>
            <a href="#">&nbsp;</a>
        </div>

        <div id="datepicker">
            <div id="widgetCalendar">

            </div>
            <div id="date_ranges">
                <span>Selecciona un periodo</span>
                <div>
                    <label for="range1_init">Desde</label>
                    <input type="text" name="range1_init" id="range1_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range1_end">Hasta</label>
                    <input type="text" name="range1_end" id="range1_end" readonly="readonly"/>
                </div>
                <label id="compare_prev_date"><input type="checkbox" id="prev_dates"/>Comparar con fechas previas</label>
                <div>
                    <label for="range2_init">Desde</label>
                    <input type="text" name="range2_init" id="range2_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range2_end">Hasta</label>
                    <input type="text" name="range2_end" id="range2_end" readonly="readonly"/>
                </div>

                <label id="compare_prev_date3"><input type="checkbox" id="prev_dates3"/>Comparar con fechas previas</label>
                <div>
                    <label for="range3_init">Desde</label>
                    <input type="text" name="range3_init" id="range3_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range3_end">Hasta</label>
                    <input type="text" name="range3_end" id="range3_end" readonly="readonly"/>
                </div>
                <label id="compare_prev_date4"><input type="checkbox" id="prev_dates4"/>Comparar con fechas previas</label>
                <div>
                    <label for="range4_init">Desde</label>
                    <input type="text" name="range2_init" id="range4_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range4_end">Hasta</label>
                    <input type="text" name="range2_end" id="range4_end" readonly="readonly"/>
                </div>


                <a href="#" class="aqua_btn">Aplicar</a>
            </div>
            <div id="widgetCalendar2">

            </div>

            <div id="widgetCalendar3">

            </div>

            <div id="widgetCalendar4">

            </div>
        </div>
    </div>

    <div class="divider" id="divider_top">&nbsp;</div>

    <div id="types_graphs">
        <ul>
            {% for type in graphs %}
                <li id="{{ type.pk }}">{{ type.object_name }}</li>
            {% endfor %}
        </ul>
    </div>
    <div id="graphs_container">
        <div id="compare" class="fl">
            <input id="evaluated_companies" type="hidden" value="{{ empresa.pk }},"/>
            <!--<span>Comparar:</span>
            <span class="compared">{{ empresa.building_name }}</span>
            <span class="vs_tag">VS</span>
            <select id="compare_to">
                <option value="0">Selecciona</option>
                {% for cntx in datacontext %}
                    <option value="{{ cntx.building.pk }}">
                        {{cntx.building.building_name}}
                    </option>
                {% endfor %}
            </select>-->
        </div>

        <div id="graph_container">
            <iframe src="/reportes/graficas/" id="graphFrame" seamless="seamless"></iframe>
        </div>

    </div>


</div>
{% endblock %}