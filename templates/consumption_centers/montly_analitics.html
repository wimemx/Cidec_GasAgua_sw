{% extends "base.html" %}
{% block titulo %}An&aacute;lisis de Consumo El&eacute;ctrico Mensual - {{ building.building_name }}{% endblock %}
{% block externalcss %}
    <!--suppress HtmlUnknownTarget -->
    <link rel="stylesheet" href="/static/css/consumption_centers/main.css" type="text/css" />
    <link rel="stylesheet" href="/static/date_picker/css/datepicker2.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/consumption_centers/montly_report.css" type="text/css" />
{% endblock %}
{% block externaljs %}
    <script type="text/javascript" src="/static/date_picker/js/datepicker.js"></script>
    <script type="text/javascript">
        var fecha_act = new Date();
        var current_month = fecha_act.getMonth()+1;
        var current_year = fecha_act.getFullYear();
        var current_day = fecha_act.format("yyyy-mm-dd");
        var lateral;
    function get_full_month(){
        var maxx_d = 0;
        var minn_d = 9000000;
        var maxx_kwh = 0;
        var min_kwh = 9000000;
        var index_maxd, index_mind, index_maxkwh, index_minkwh;
        $.ajax({
            url: "/buildings/month_analitics/{{ building.pk }}/"+String(current_year)+"/"+String(current_month)+"/",
            type: "GET",
            success: function(data){
                for(var j=0; j<data.length; j++){
                    var datoi = data[j];
                    if(datoi.empty == "false"){
                        if(datoi.max_demand > maxx_d){
                            maxx_d = datoi.max_demand;
                            index_maxd = j;
                        }
                        if(datoi.KWH_total > maxx_kwh){
                            maxx_kwh = datoi.KWH_total;
                            index_maxkwh = j;
                        }
                        if(datoi.max_demand < minn_d){
                            minn_d = datoi.max_demand;
                            index_mind = j;
                        }
                        if(datoi.KWH_total < min_kwh){
                            min_kwh = datoi.KWH_total;
                            index_minkwh = j;
                        }
                    }
                }

                for(var i=0; i<data.length; i++){
                    var dato = data[i];
                    var div = "<div class='inner_day fr'>";
                    var class_d = '';
                    var class_k = '';
                    if(data[i].empty == "true"){
                        //div += "<span class='title_inner'>&nbsp;</span>";
                        div += "<span class='demanda_max'>-</span>";
                        div += "<span class='title_inner'>&nbsp;</span>";
                        div += "<span class='consumo'>-</span>";
                        div += "</div>";
                    }else{
                        //div += "<span class='title_inner'>&nbsp;</span>";
                        if(i == index_maxd){
                            class_d = "red";
                        }
                        if(i == index_mind){
                            class_d = "green";
                        }
                        if(i == index_maxkwh){
                            class_k = "red";
                        }
                        if(i == index_minkwh){
                            class_k = "green";
                        }
                        div += "<span class='demanda_max "+class_d+"'>"+ dato.max_demand +" kW</span>";
                        div += "<span class='title_inner'>&nbsp;</span>";
                        div += "<span class='consumo "+class_k+"'>"+ dato.KWH_total +" kWh</span>";
                        div += "</div>";
                    }
                    $("."+dato.fecha).append(div);
                }
            }
        });
        $.ajax({
            url: "/buildings/month_analitics_h/{{ building.pk }}/"+String(current_year)+"/"+String(current_month)+"/",
            type: "GET",
            success: function(data){
                $("#cons_total").text(addCommas(data[0].consumo_acumulado) + "kWh");
                $("#dem_total").text(addCommas(data[0].demanda_max) + "kW");
                $("#pp_total").text(String(data[0].factor_potencia.toFixed(2)) + "%");
                var month_totals = $(".month_totals");
                month_totals.find("#month_dem_min").text(addCommas(data[0].demanda_min) + "kW");
                month_totals.find("#month_cons_prom").text(addCommas(data[0].consumo_promedio.toFixed(2)) + "kWh");
                month_totals.find("#month_cons_med").text(addCommas(data[0].consumo_mediana.toFixed(2)) + "kWh");
                month_totals.find("#month_cons_des").text(addCommas(data[0].consumo_desviacion.toFixed(2)) + "kWh");
            }
        });
    }

    function load_day(day){
        var fecha = day.split("-");
        fecha = new Date(parseInt(fecha[0]), parseInt(fecha[1])-1, parseInt(fecha[2]));
        fecha = dateFormat(fecha, "dddd d, mmmm");
        $.ajax({
            url: "/buildings/month_analitics_day/{{ building.pk }}/?date="+day,
            type: "GET",
            success: function(data){

                data = data[0];
                var lateral_content = '<span id="close"></span>';
                lateral_content +=     '<h2>'+ fecha+'</h2>';
                lateral_content +=     '<span class="lat_sep"></span>';
                if(data.empty == "true"){
                    lateral_content +=     '<span class="no_data">No hay informaci&oacute;n para este d&iacute;a</span>';
                }else{
                    lateral_content +=     '<h3>Consumo</h3>';
                    lateral_content +=     '<div id="lat_consumo">';
                    lateral_content +=     '<span class="m_value">'+ addCommas(data.c_tot)+' kWh</span>';
                    lateral_content +=     '<span class="s_value">'+ addCommas(data.c_base)+'kWh base</span>';
                    lateral_content +=     '<span class="s_value">'+ addCommas(data.c_int)+'kWh intermedia</span>';
                    lateral_content +=     '<span class="s_value">'+ addCommas(data.c_punta)+'kWh punta</span>';
                    lateral_content +=     '</div>';
                    lateral_content +=     '<a href="/main/">Ver en una gr&aacute;fica</a>';
                    lateral_content +=     '<h3>Demanda M&aacute;x</h3>';
                    lateral_content +=     '<div id="lat_demanda">';
                    lateral_content +=     '<span class="m_value">'+ addCommas(data.d_max)+' kW</span>';
                    lateral_content +=     '<span class="s_value">'+ addCommas(data.d_max_time)+'</span>';
                    lateral_content +=     '</div>';
                    lateral_content +=     '<a href="/main/">Ver en una gr&aacute;fica</a>';
                    lateral_content +=     '<h3>Costo Promedio</h3>';
                    lateral_content +=     '<div id="lat_costo">';
                    lateral_content +=     '<span class="m_value">$'+ addCommas(data.cost_p)+'</span>';
                    lateral_content +=     '<span class="s_value">MXN</span>';
                    lateral_content +=     '</div>';
                    lateral_content +=     '<span class="aditional">Factor Potencia: '+ data.pf+'%</span>';
                    lateral_content +=     '<span class="aditional">kVArh: '+ addCommas(data.kvarh) +' KVar</span>';
                }
                $("#lateral").html(lateral_content);
            }
        });
    }

    function close_lat(){
        lateral.animate({width: 'toggle', right: "0"}, 500, function(){
            $(this).addClass("collapsed");
            $(this).css('opacity', '0');
        });
    }
    function open_lat(){
        if(lateral.hasClass("collapsed")){
            lateral.removeClass("collapsed");
            lateral.show().animate({width: '240px', right: "-249px", opacity: "1"}, 500);
        }
    }

    </script>
{% endblock %}
{% block document_ready %}
    lateral = $("#lateral");
    close_lat();
    $("#close").live("click", function(e){
        close_lat();
    });
    $("#week_s").click(function(){
        $.ajax({
            url: "/buildings/month_analitics_week/{{ building.pk }}/"+String(current_year)+"/"+String(current_month)+"/",
            type: "GET",
            success: function(data){

                lateral.html('<span id="close"></span><h2>Reporte Semanal</h2><span class="lat_sep"></span>');
                var cont = 0;
                $(".datepickerWeek a span").each(function(){
                    valor = $(this).text();
                    semana = parseInt(valor)
                    if(semana){
                        var acum=0;
                        if(data[cont].consumo_acumulado != null){
                            acum = data[cont].consumo_acumulado
                        }

                        var div = "<div class='semana_cont'>";
                        div += "<span class='week_num fl'>S"+ String(semana) +"</span>";
                        div += "<div class='week_values_cont fr'>";
                        div += "<span class='label_wvalue'>Consumo Acumulado:";
                        div += "<span class='wvalue'> "+acum+" kWh</span></span>";
                        div += "<span class='label_wvalue'>Demanda M&aacute;x:";
                        div += "<span class='wvalue'> "+data[cont].demanda_max+" kW</span></span>";
                        div += "<span class='label_wvalue'>Demanda Mínima:";
                        div += "<span class='wvalue'> "+data[cont].demanda_min+" kW</span></span>";
                        div += "<span class='label_wvalue'>Consumo Promedio:";
                        div += "<span class='wvalue'> "+data[cont].consumo_promedio.toFixed(2)+" kWh</span></span>";
                        div += "<span class='label_wvalue'>Consumo Media:";
                        div += "<span class='wvalue'> "+data[cont].consumo_mediana.toFixed(2)+" kWh</span></span>";
                        div += "<span class='label_wvalue'>Consumo Desviación:";
                        div += "<span class='wvalue'>"+data[cont].consumo_desviacion.toFixed(2)+" kWh</span></span>";
                        div += "</div>";
                        lateral.append(div);
                        cont++;
                    }
                });
                open_lat();
            }
        });
    });

    $('#widgetCal').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [fecha_act],
        calendars: 1,
        starts: 7,
        onChange: function(month, selected) {
            var display_day = false;
            console.log("selected", selected)
            current = month.split("-");
            c_month = current[1];
            c_year = current[0];

            //month name as auxiliar for the events of loading info
            var mes = parseInt(current_month);
            if(mes < 10){
                mes = "0" + String(mes);
            }else{
                mes = String(mes);
            }
            if(c_month != current_month || c_year != current_year ){
                var class_name = "."+String(current_year) + "-" + mes + "-15";
                if(!$(class_name).size()){
                    console.log("cambio de mes");
                    current_month = c_month;
                    current_year = c_year;
                    close_lat();
                    display_day = false;
                    get_full_month();
                }else{
                    display_day = true;
                }
            }else{
                display_day = true;
            }

            if(display_day){
                if(current_day != selected){
                    current_day = selected;
                    console.log("carga la información del día");
                    load_day(selected);
                }else{
                    console.log("muestra solamente");
                }
                open_lat();

            }

        },
        onRender: function(date){
            //maneja los eventos al generar cada día
            return {selected: false, disabled: false, className: "day_cal"+" "+date.format("yyyy-mm-dd")};
        }
    });
    get_full_month();
{% endblock %}
{% block contenido %}
    
    <div id="bread_crumbs">
        <ul>
            <li><a href="/main/">Inicio</a></li>
            <li><a href="/reportes/analisis_mensual/">An&aacute;lisis de Consumo El&eacute;ctrico Mensual</a></li>
        </ul>
    </div>
    <div id="page_content">
    <div id="contenido_interno">
        <h2 id="titulo_reporte">An&aacute;lisis de Consumo El&eacute;ctrico Mensual - {{ building.building_name }}</h2>

        <div class="divider" id="divider_top">&nbsp;</div>

        <div id="month_sumary">
            <h3>Reporte Mensual</h3>
            <div class="icon_sumary consumo_t">
                <span id="cons_total">
                    -
                </span>
                <span>Consumo acumulado/ m</span>
            </div>
            <div class="icon_sumary demanda">
                <span id="dem_total">
                    -
                </span>
                <span>Demanda Máxima / m</span>
            </div>
            <div class="icon_sumary emisiones">
                <span id="emit_total">
                    404 ton
                </span>
                <span>Emisiones de CO2</span>
            </div>
            <div class="icon_sumary potencia">
                <span id="pp_total">
                    -
                </span>
                <span>Factor de Potencia</span>
            </div>
            <div class="month_totals">
                <span class="label_tot">Demanda Mínima</span>
                <span class="value_tot" id="month_dem_min">-</span>

                <span class="label_tot">Comsumo promedio</span>
                <span class="value_tot" id="month_cons_prom">-</span>

                <span class="label_tot">Consumo media</span>
                <span class="value_tot" id="month_cons_med">-</span>

                <span class="label_tot">Consumo desviación</span>
                <span class="value_tot"  id="month_cons_des">-</span>
            </div>
        </div>

        <div id="widgetCal">
            <span class="ringl"></span>
            <span class="ringr"></span>
            <div id="week_s">
                Ver resumen semanal
            </div>
            <div id="lateral">

            </div>

        </div>
    </div>
    </div>
{% endblock %}