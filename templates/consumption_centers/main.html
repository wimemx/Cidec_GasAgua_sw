{% extends "base.html" %}
{% block titulo %}Reportes{% endblock %}
{% block externalcss %}
    <link rel="stylesheet" href="/static/css/consumption_centers/main.css" type="text/css">
    <link rel="stylesheet" href="/static/date_picker/css/datepicker.css" type="text/css" />
    <link rel="stylesheet" href="/static/js/external/fancybox/jquery.fancybox.css" type="text/css" />
{% endblock %}
{% block externaljs %}
    <script type="text/javascript" src="/static/js/external/fancybox/jquery.fancybox.js"></script>
    <script type="text/javascript" src="/static/date_picker/js/date_picker.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load('visualization', '1.1', {packages: ['corechart', 'controls']});
    </script>
    <script type="text/javascript">

    function clean_dates(url){
        var f1_init = encodeURIComponent($("#range1_init").val());
        var f1_end = encodeURIComponent($("#range1_end").val());
        var f2_init = encodeURIComponent($("#range2_init").val());
        var f2_end = encodeURIComponent($("#range2_end").val());

        url=url.replace('#','').split("?");
        if (url.length > 1){
            //if url has get_vars
            var hash = url[1];
            hash = hash.replace(/&{0,1}date-start01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-start02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            hash = hash.replace(/&{0,1}date-end02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}&{0,1}/, '');
            //hash is equal to all the get vars but the dates
            url = url[0] + "?" + hash + "&";
        }else{
            url+="?";
        }

        if(f1_init != ''){
            url += "date-start01=" + f1_init;

        }else{
            var fecha_ini = new Date();
            fecha_ini.setDate(fecha_ini.getDate()-30);
            url += "date-start01=" + encodeURIComponent(fecha_ini.format("yyyy-mm-dd"));
        }
        if(f1_end != ''){
            url += "&date-end01=" + f1_end;
        }else{
            url += "&date-end01=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
        }

        if(f2_init != ''){
            url += "&date-start02=" + f2_init;
            if(f2_end != ''){
                url += "&date-end02=" + f2_end;
            }else{
                url += "&date-end02=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
            }
        }
        return url;
    }

    function graphsReload(){
        /* Takes the date in the range inputs and reloads the graph data */

        var f1_init = encodeURIComponent($("#range1_init").val());
        var f1_end = encodeURIComponent($("#range1_end").val());
        var f2_init = encodeURIComponent($("#range2_init").val());
        var f2_end = encodeURIComponent($("#range2_end").val());
        if(f1_init!=''){
            var url = $("#graphFrame").attr("src").replace('#','').split("?");

            if (url.length > 1){
                var hash = url[1];

                hash = hash.replace(/&{0,1}date-start01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}/, '');
                hash = hash.replace(/&{0,1}date-end01=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}/, '');
                hash = hash.replace(/&{0,1}date-start02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}/, '');
                hash = hash.replace(/&{0,1}date-end02=\d{4}(\-|\/|\.|(%2F))\d{1,2}\1\d{1,2}/, '');
                url = url[0] + "?" + hash + "&";




                url += "date-start01=" + f1_init;
                if(f1_end != ''){
                    url += "&date-end01=" + f1_end;
                }else{
                    url += "&date-end01=" + encodeURIComponent(new Date().format("yyyy-mm-dd"));
                }
                if(f2_init != ''){
                    url += "&date-start02=" + f2_init;
                    if(f2_end != ''){
                        url += "&date-end02=" + f2_end;
                    }else{
                        url += "&date-end02=" + encodeURIComponent(new Date());
                    }
                }

                makeIframe(url);
            }else{
                $("#graph_container").html("<h2>Por favor, " +
                        "primero seleccione el tipo de gr&aacute;fica a mostrar</h2>" +
                        "<iframe id='graphFrame' src=''>" +
                        "</iframe>");
            }

        }

    }
    function refresh_iframe_height(){
        // regresca el height del iframe para ajustarse a su conte
        setTimeout("parent.document.getElementById('graphFrame').height = document['body'].offsetHeight;", 1000);
    }
    function makeIframe(src){
        var graphFrame = document.createElement("IFRAME");
        graphFrame.id = "graphFrame";
        graphFrame.src = src;
        $("#graph_container").html(graphFrame);
        refresh_iframe_height();
    }
    </script>
{% endblock %}
{% block document_ready %}

    var url = window.location.href;
    window.history.replaceState(url,"Reporte el&eacute;ctrico", url);





    var now3 = new Date();
    now3.addDays(-4);
    var now4 = new Date();
    var mul_date = false;
    $('#widgetCalendar').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range1_init').val(formated[0]);
            $('#range1_end').val(formated[1]);
            if(!mul_date){
                $('#widgetField span').css('font-size','16px');
                $('#widgetField span').get(0).innerHTML = formated.join(' &ndash; ');
            }else{
                $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            }
        }
    });
    $('#widgetCalendar').DatePickerClear();
    $('#widgetCalendar2').DatePickerClear();
    $('#widgetCalendar2').DatePicker({
        flat: true,
        format: 'Y-m-d',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range2_init').val(formated[0]);
            $('#range2_end').val(formated[1]);
            $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val();
            $('#widgetField span').get(0).innerHTML = $('#widgetField span').html() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            $('#widgetField span').css('font-size','11px');

        }
    });
    $('#widgetCalendar2').DatePickerClear();
    var state = false;
    $('#widgetField').click(function(){
        $('#datepicker').slideToggle();
    });
    $("#date_ranges .aqua_btn").click(function(e){
        //aplicar el(los) rangos de fecha seleccionados
        e.preventDefault();
        $('#datepicker').slideUp();
        graphsReload();
    });
    $("#prev_dates").click(function(){
        //maneja la visibilidad del calendario del rango adicional
        if($("#widgetCalendar2").is(":visible")){
            mul_date = false;
            $('#range2_init').val("");
            $('#range2_end').val("");
            $('#widgetField span').html($('#widgetField span').html().split(" contra: ")[0]);
            $('#widgetCalendar2').DatePickerClear();
        }else{
            mul_date = true;
        }
        $("#widgetCalendar2").slideToggle();
    });

    $("#types_graphs ul li").each(function(){
        // Carga el iframe de la grafica correspondiente,
        $(this).click(function(){
            $("#types_graphs ul li").each(function(){$(this).removeClass("active");});
            var src;
            switch($(this).attr("id")){
                {% for type in graphs %}
                case "{{ type.pk }}":
                    src = "{{ type.object_access_point }}";
                    break;
                {% endfor %}
            }
            var get_vars = $("#graphFrame").attr("src").split('?')[1]


            if(get_vars != undefined){
                get_vars=get_vars.replace(/&consumer\-unit01=\w*/g,"");
                get_vars=get_vars.replace(/graph=\w*/g,"");
                get_vars=get_vars.replace(/&granularity=\w*/g,"");


                src += get_vars;

            }else{
                src = clean_dates(src);

            }
            src+="&consumer-unit01="+{{ consumer_unit.pk }}+"&granularity=hour";

            makeIframe(src);
            //cambia la clase de la pestania
            $(this).addClass("active");

        });
    });
    $("#compare_to").change(function(){
        //agrega y refresca los datos para ser comparados contra otra entidad
        var compared_companies=$("#evaluated_companies").val().split(",");
        if($(this).val()!=0 && compared_companies.length < 4){

            var bandera = true;
            for(var comp = 0; comp < compared_companies.length; comp++){
                //check if the entitie is compared with self, or some entity already added
                if(compared_companies[comp] == $(this).val()) bandera = false;
            }
            if(bandera){
                var src=$("#graphFrame").attr("src").split('?');
                var iframesrc = src[0] + '?';

                if (src[1] != undefined){
                    iframesrc += src[1] + '&';
                }
                iframesrc += "compare_to" + $(this).val() + "=" + $(this).val();
                $(this).parent().before('<span class="compared">' + $("#compare_to option:selected").text()
                                    + '</span><span class="vs_tag">VS</span>');
                src = iframesrc;

                makeIframe(src);
                $("#evaluated_companies").val($("#evaluated_companies").val() + "," + $(this).val());
            }
        }
    });

    refresh_iframe_height();

    //custom select for sidebar
    $("#empresa").click(function(){
        $("#company_list").slideToggle();
    });
    $("#company_list li").click(function(){
        var texto=$(this).text().replace(/^\s*|\s*$/g,'');
        var texto1 = texto.substring(0,17) + "...";
        $("#empresa").text(texto1);
        $("#company_list").slideUp();
        //reload with the selected company data
        $("#evaluated_companies").val($(this).attr("rel") + ",");
        $(".compared").remove();
        $(".vs_tag").remove();
        $("#compare_to").parent().before('<span class="compared">'+
            texto +
            '</span>' +
            '<span class="vs_tag">VS</span>'
        );
        $.ajax({
            url: "/reportes/set_default_building/" + $(this).attr("rel"),
            type: "GET",
            dataType: 'json',
            async: 'true',
            success: function(datos){
                document.location.reload(true);
            }
        });
        var src = $("#graphFrame").attr("src").split('?')[0];
        $("#widgetField span").html("Fecha Inicio &ndash; Fecha Fin");
        $("#range1_init").val("");
        $("#range1_end").val("");
        $("#range2_init").val("");
        $("#range2_end").val("");
        $('#widgetCalendar').DatePickerClear();
        $('#widgetCalendar2').DatePickerClear();
        $("#types_graphs ul li").removeClass("active");
        makeIframe("");
    });
    $(".various").fancybox({
        maxWidth	: 800,
        maxHeight	: 800,
        fitToView	: false,
        width		: '70%',
        height		: '70%',
        autoSize	: false,
        closeClick	: false,
        openEffect	: 'none',
        closeEffect	: 'none'
    });
    {% endblock %}
{% block contenido %}
<div id="bread_crumbs">
    <ul>
        <li><a href="/main/">Inicio</a></li>
        <li><a href="/main/">Reportes</a></li>
    </ul>

</div>
<div id="contenido_interno">
    <h2 id="titulo_reporte">{{ empresa.building_name }} -
        <span>
            {% if consumer_unit.part_of_building %}
                {{ consumer_unit.part_of_building.part_of_building_name }}
            {% else %}
                {{ consumer_unit.electric_device_type.electric_device_type_name }}
            {% endif %}
        </span>
    </h2><a class="various" data-fancybox-type="iframe"  href="/reportes/set_consumer_unit/">Cambiar</a>

    <div id="datepicker_component">
        <span class="period_tag">Periodo</span>
        <div id="widgetField">
            <span>Fecha Inicio &ndash; Fecha Fin</span>
            <a href="#">&nbsp;</a>
        </div>

        <div id="datepicker">
            <div id="widgetCalendar">

            </div>
            <div id="date_ranges">
                <span>Selecciona un periodo</span>
                <div>
                    <label for="range1_init">Desde</label>
                    <input type="text" name="range1_init" id="range1_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range1_end">Hasta</label>
                    <input type="text" name="range1_end" id="range1_end" readonly="readonly"/>
                </div>
                <label id="compare_prev_date"><input type="checkbox" id="prev_dates">Comparar con fechas previas</label>
                <div>
                    <label for="range2_init">Desde</label>
                    <input type="text" name="range2_init" id="range2_init" readonly="readonly"/>
                </div>
                <span>&ndash;</span>
                <div>
                    <label for="range2_end">Hasta</label>
                    <input type="text" name="range2_end" id="range2_end" readonly="readonly"/>
                </div>
                <a href="#" class="aqua_btn">Aplicar</a>
            </div>
            <div id="widgetCalendar2">

            </div>
        </div>
    </div>

    <div class="divider" id="divider_top">&nbsp;</div>

    <div id="types_graphs">
        <ul>
            {% for type in graphs %}
                <li id="{{ type.pk }}">{{ type.object_name }}</li>
            {% endfor %}
        </ul>
    </div>
    <div id="graphs_container">
        <div id="compare" class="fl">
            <input id="evaluated_companies" type="hidden" value="{{ empresa.pk }},"/>
            <!--<span>Comparar:</span>
            <span class="compared">{{ empresa.building_name }}</span>
            <span class="vs_tag">VS</span>
            <select id="compare_to">
                <option value="0">Selecciona</option>
                {% for cntx in datacontext %}
                    <option value="{{ cntx.building.pk }}">
                        {{cntx.building.building_name}}
                    </option>
                {% endfor %}
            </select>-->
        </div>

        <div id="graph_container">
            <iframe src="/reportes/graficas/" id="graphFrame" seamless="seamless"></iframe>
        </div>

    </div>


</div>
{% endblock %}