{% extends "base.html" %}
{% block titulo %}Reportes{% endblock %}
{% block externalcss %}
    <link rel="stylesheet" href="/static/css/consumption_centers/main.css">
    <link rel="stylesheet" href="/static/js/external/datepicker/css/datepicker.css" type="text/css" />
{% endblock %}
{% block externaljs %}
    <script type="text/javascript" src="/static/js/external/datepicker/js/datepicker.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load('visualization', '1.1', {packages: ['corechart', 'controls']});
    </script>
    <script type="text/javascript">

    function graphsReload(){
        /* Takes the date in the range inputs and reloads the graph data */
    }
    function refresh_iframe_height(){
        // regresca el height del iframe para ajustarse a su conte
        setTimeout("parent.document.getElementById('graphFrame').height = document['body'].offsetHeight;", 1000);
    }
    </script>
{% endblock %}
{% block document_ready %}

    $(".desp").click(function(){
        $(this).next().slideToggle();
    });
    $("#nav_toggle").click(function(){
        //maneja el evento de colapsar o mostrar la barra de navegacion
        if($("#sidebar").hasClass("collapsed_nav")){

            $("#sidebar").animate({width: 'toggle',}, 500, function(){
                $(this).removeClass("collapsed_nav");
            });
            $("#sidebar_content").show('slide', {direction: 'right'}, 100);
            $("footer").show('slide', {direction: 'right'}, 100);

        }else{
            $("#sidebar").addClass("collapsed_nav");
            $("#sidebar_content").hide('slide', {direction: 'left'}, 100);
            $("footer").hide('slide', {direction: 'left'}, 100);
            $("#sidebar").animate({width: 'toggle',}, 500);
        }
        $("#nav_toggle").toggleClass("closed");
    });

    var now3 = new Date();
    now3.addDays(-4);
    var now4 = new Date()
    var mul_date = false;
    $('#widgetCalendar').DatePicker({
        flat: true,
        format: 'd/m/Y',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range1_init').val(formated[0]);
            $('#range1_end').val(formated[1]);
    console.log(mul_date);
            if(!mul_date){
                $('#widgetField span').css('font-size','16px');
                $('#widgetField span').get(0).innerHTML = formated.join(' &ndash; ');
            }else{
                $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            }
        }
    });
    $('#widgetCalendar').DatePickerClear();
    $('#widgetCalendar2').DatePickerClear();
    $('#widgetCalendar2').DatePicker({
        flat: true,
        format: 'd/m/Y',
        date: [new Date(now3), new Date(now4)],
        calendars: 2,
        mode: 'range',
        starts: 1,
        onChange: function(formated) {
            $('#range2_init').val(formated[0]);
            $('#range2_end').val(formated[1]);
            $('#widgetField span').get(0).innerHTML = $('#range1_init').val() + " &ndash; " + $('#range1_end').val();
            $('#widgetField span').get(0).innerHTML = $('#widgetField span').html() + " contra: " + $('#range2_init').val() + " &ndash; " + $('#range2_end').val();
            $('#widgetField span').css('font-size','11px');

        }
    });
    $('#widgetCalendar2').DatePickerClear();
    var state = false;
    $('#widgetField').click(function(){
        $('#datepicker').slideToggle();
    });
    $("#date_ranges .aqua_btn").click(function(e){
        //aplicar el(los) rangos de fecha seleccionados
        e.preventDefault();
        $('#datepicker').slideUp();
        graphsReload();
    });
    $("#prev_dates").click(function(){
        //maneja la visibilidad del calendario del rango adicional
        if($("#widgetCalendar2").is(":visible")){
            mul_date=false;
            $('#range2_init').val("");
            $('#range2_end').val("");
            $('#widgetField span').html($('#widgetField span').html().split(" contra: ")[0]);
            $('#widgetCalendar2').DatePickerClear();
        }else{
            mul_date=true;
        }
        $("#widgetCalendar2").slideToggle();
    });

    $("#types_graphs ul li").each(function(){
        // Carga el iframe de la grafica correspondiente,
        $(this).click(function(){
            $("#types_graphs ul li").each(function(){$(this).removeClass("active");});
            var graphFrame =document.createElement("IFRAME");
            graphFrame.id = "graphFrame";
            switch($(this).attr("id")){
                case "kw":
                    graphFrame.src = "/reportes/potencia_activa/";
                    break;
                case "kvar":
                    graphFrame.src = "/reportes/potencia_reactiva/";
                    break;
                case "pf":
                    graphFrame.src = "/reportes/factor_potencia/";
                    break;
                case "profile":
                    graphFrame.src = "/reportes/perfil_carga/";
                    break;
            }
            $("#graph_container").html(graphFrame);
            //cambia la clase de la pestania
            $(this).addClass("active");
            //cambia el height del iframe de a cuerdo al contenido
            refresh_iframe_height();
        });
    });
    $("#compare_to").change(function(){
        //agrega y refresca los datos para ser comparados contra otra entidad
        var src=$("#graphFrame").attr("src").split('?')
        var iframesrc = src[0] + '?';
        console.log(src[1] != undefined);
        if (src[1] != undefined){
            iframesrc += src[1] + '&';
        }
        iframesrc += "compare_to=" + $(this).val();
        $(this).parent().before('<span class="compared">'+$("#compare_to option:selected").text()
                        +'</span><span class="vs_tag">VS</span>');
        var graphFrame =document.createElement("IFRAME");
        graphFrame.id = "graphFrame";
        graphFrame.src = iframesrc;
        $("#graph_container").html(graphFrame);
        refresh_iframe_height();
    });


    refresh_iframe_height();
    //custom select for sidebar

    $("#empresa").click(function(){
        $("#company_list").slideToggle();
    });
    $("#company_list li").click(function(){
        texto=$(this).text().replace(/^\s*|\s*$/g,'');;
        texto=texto.substring(0,17)+"...";
        $("#empresa").text(texto);
        $("#company_list").slideUp();
        //reload with the selected company data
    });
{% endblock %}
{% block contenido %}
<div id="bread_crumbs">
    <ul>
        <li><a href="/main/">Inicio</a></li>
        <li><a href="/main/">Reportes</a></li>
    </ul>

</div>
<div id="contenido_interno">
    <h2 id="titulo_reporte">Reporte de Perfil de Carga</h2>

    <div id="datepicker_component">
        <span class="period_tag">Periodo</span>
        <div id="widgetField">
            <span>Fecha Inicio &ndash; Fecha Fin</span>
            <a href="#">&nbsp;</a>
        </div>

        <div id="datepicker">
            <div id="widgetCalendar">

            </div>
            <div id="date_ranges">
                <span>Selecciona un periodo</span>
                <div>
                    <label>Desde</label>
                    <input type="text" name="range1_init" id="range1_init">
                </div>
                <span>&ndash;</span>
                <div>
                    <label>Hasta</label>
                    <input type="text" name="range1_end" id="range1_end">
                </div>
                <span><input type="checkbox" id="prev_dates">Comparar con fechas previas</span>
                <div>
                    <label>Desde</label>
                    <input type="text" name="range2_init" id="range2_init">
                </div>
                <span>&ndash;</span>
                <div>
                    <label>Hasta</label>
                    <input type="text" name="range2_end" id="range2_end">
                </div>
                <a href="#" class="aqua_btn">Aplicar</a>
            </div>
            <div id="widgetCalendar2">

            </div>
        </div>
    </div>

    <div class="divider" id="divider_top">&nbsp;</div>

    <div id="types_graphs">
        <ul>
            <li id="kw" class="active">Potencia Activa (KW)</li>
            <li id="kvar">Potencia Reactiva (KVar)</li>
            <li id="pf">Factor de Potencia (PF)</li>
            <li id="profile">Perfil de Carga</li>
        </ul>
    </div>
    <div id="graphs_container">
        <div id="compare" class="fl">
            <span>Comparar:</span>
            <span class="compared">Sears Galer&iacute;as Quer&eacute;taro</span>
            <span class="vs_tag">VS</span>
            <select id="compare_to">
                <option>Selecciona</option>
                <option value="1">Sanborns Galer&iacute;as Quer&eacute;taro</option>
                <option value="2">Sanborns Plaza del Parque Quer&eacute;taro</option>
            </select>
        </div>

        <div id="graph_container">
            {% if type == "graphs" %}
                <iframe src="/reportes/potencia_activa/" id="graphFrame"></iframe>
            {% endif %}
        </div>

    </div>


</div>
{% endblock %}